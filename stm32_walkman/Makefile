# STM32 Walkman Player - Makefile
# Adapted for STM32F4 using ARM GCC

TARGET = stm32_walkman
CROSS_COMPILE = arm-none-eabi-
CC = $(CROSS_COMPILE)gcc
OBJCOPY = $(CROSS_COMPILE)objcopy
AR = $(CROSS_COMPILE)ar
SIZE = $(CROSS_COMPILE)size

# Directories
BUILD_DIR = build
OBJ_DIR = $(BUILD_DIR)/obj
SRC_DIR = src

# Source files
SOURCES = \
	src/main.c \
	src/audio/player.c \
	src/lcd/lcd_display.c \
	src/buttons/buttons.c

# HAL sources (generated by STM32CubeMX)
HAL_SOURCES = \
	Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_hal.c \
	Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_hal_gpio.c \
	Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_hal_spi.c \
	Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_hal_i2s.c \
	Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_hal_sd.c \
	Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_hal_rcc.c \
	Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_hal_cortex.c

# Startup and system
STARTUP = Drivers/CMSIS/Device/ST/STM32F4xx/Source/Templates/gcc/startup_stm32f407xx.s
SYSTEM = Drivers/CMSIS/Device/ST/STM32F4xx/Source/Templates/system_stm32f4xx.c

OBJECTS = $(addprefix $(OBJ_DIR)/, $(notdir $(SOURCES:.c=.o)))
OBJECTS += $(addprefix $(OBJ_DIR)/, $(notdir $(HAL_SOURCES:.c=.o)))
OBJECTS += $(OBJ_DIR)/startup.o
OBJECTS += $(OBJ_DIR)/system.o

# Compiler flags
CPU_FLAGS = -mcpu=cortex-m4 -mthumb -mfpu=fpv4-sp-d16 -mfloat-abi=hard
COMMON_FLAGS = $(CPU_FLAGS) -ffunction-sections -fdata-sections -g3
CFLAGS = $(COMMON_FLAGS) -Wall -Wextra -O2

# Include paths
INCLUDES = \
	-IDrivers/STM32F4xx_HAL_Driver/Inc \
	-IDrivers/CMSIS/Device/ST/STM32F4xx/Include \
	-IDrivers/CMSIS/Include \
	-Isrc \
	-Isrc/audio \
	-Isrc/lcd \
	-Isrc/buttons

# Defines
DEFINES = -DSTM32F407xx -DUSE_HAL_DRIVER

# Linker script
LDSCRIPT = LinkerScript/STM32F407VGTx_FLASH.ld
LDFLAGS = -T$(LDSCRIPT) $(CPU_FLAGS) -Wl,--gc-sections,-Map=$(BUILD_DIR)/$(TARGET).map
LIBS = -lc -lm

# Output files
ELF = $(BUILD_DIR)/$(TARGET).elf
HEX = $(BUILD_DIR)/$(TARGET).hex
BIN = $(BUILD_DIR)/$(TARGET).bin

.PHONY: all clean flash debug

all: $(BIN) $(HEX)
	@echo "Build complete!"
	@$(SIZE) $(ELF)

$(BIN): $(ELF)
	@$(OBJCOPY) -O binary $< $@
	@echo "Created binary: $@"

$(HEX): $(ELF)
	@$(OBJCOPY) -O ihex $< $@
	@echo "Created hex: $@"

$(ELF): $(OBJECTS)
	@mkdir -p $(BUILD_DIR)
	@echo "Linking $@..."
	@$(CC) $(OBJECTS) $(LDFLAGS) $(LIBS) -o $@

$(OBJ_DIR)/%.o: src/%.c
	@mkdir -p $(OBJ_DIR)
	@echo "Compiling $<..."
	@$(CC) $(CFLAGS) $(DEFINES) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/%.o: src/audio/%.c
	@mkdir -p $(OBJ_DIR)
	@echo "Compiling $<..."
	@$(CC) $(CFLAGS) $(DEFINES) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/%.o: src/lcd/%.c
	@mkdir -p $(OBJ_DIR)
	@echo "Compiling $<..."
	@$(CC) $(CFLAGS) $(DEFINES) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/%.o: src/buttons/%.c
	@mkdir -p $(OBJ_DIR)
	@echo "Compiling $<..."
	@$(CC) $(CFLAGS) $(DEFINES) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/%.o: Drivers/STM32F4xx_HAL_Driver/Src/%.c
	@mkdir -p $(OBJ_DIR)
	@echo "Compiling HAL $<..."
	@$(CC) $(CFLAGS) $(DEFINES) $(INCLUDES) -c $< -o $@

$(OBJ_DIR)/startup.o: $(STARTUP)
	@mkdir -p $(OBJ_DIR)
	@echo "Assembling startup..."
	@$(CC) $(CFLAGS) -c $< -o $@

$(OBJ_DIR)/system.o: $(SYSTEM)
	@mkdir -p $(OBJ_DIR)
	@echo "Compiling system file..."
	@$(CC) $(CFLAGS) $(DEFINES) $(INCLUDES) -c $< -o $@

flash: $(BIN)
	@echo "Flashing to device..."
	@st-flash write $(BIN) 0x08000000

debug: $(ELF)
	@arm-none-eabi-gdb -ex "target remote localhost:3333" -ex "load" $(ELF)

clean:
	@rm -rf $(BUILD_DIR)
	@echo "Cleaned build artifacts"

help:
	@echo "STM32 Walkman Player Build System"
	@echo "Targets:"
	@echo "  all     - Build all files (default)"
	@echo "  clean   - Remove build artifacts"
	@echo "  flash   - Flash binary to STM32 device"
	@echo "  debug   - Launch debugger with gdb"
	@echo "  help    - Display this help message"
